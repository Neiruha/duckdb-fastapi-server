CREATE TABLE banned_users(ban_id VARCHAR PRIMARY KEY, user_id VARCHAR, telegram_user_id BIGINT, reason VARCHAR, banned_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL);;
CREATE TABLE bot_state(telegram_user_id BIGINT PRIMARY KEY, user_id VARCHAR, state_json JSON NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL);;
CREATE TABLE client_tokens(token_id VARCHAR PRIMARY KEY, user_id VARCHAR NOT NULL, telegram_user_id BIGINT NOT NULL, token_hash VARCHAR NOT NULL, "role" VARCHAR DEFAULT('client') NOT NULL, issued_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, expires_at TIMESTAMP NOT NULL, revoked_at TIMESTAMP, user_agent VARCHAR, ip_hash VARCHAR, last_used_at TIMESTAMP);;
CREATE TABLE creatures(creature_id VARCHAR PRIMARY KEY, owner_user_id VARCHAR NOT NULL, "name" VARCHAR NOT NULL, persona VARCHAR, avatar_url VARCHAR, is_system BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL);;
CREATE TABLE messages(message_id VARCHAR, message_type VARCHAR, origin VARCHAR, sender_user_id VARCHAR, sender_creature_id VARCHAR, telegram_username VARCHAR, telegram_user_id BIGINT, related_sys_event_id VARCHAR, related_track_step_id VARCHAR, "content" VARCHAR, message_data_json JSON, log_data VARCHAR, created_at TIMESTAMP);;
CREATE TABLE message_recipients(message_id VARCHAR, recipient_user_id VARCHAR, read_flag BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, read_at TIMESTAMP, PRIMARY KEY(message_id, recipient_user_id));;
CREATE TABLE message_types(message_type VARCHAR PRIMARY KEY, description VARCHAR);;
CREATE TABLE metrics(metric_id VARCHAR PRIMARY KEY, kind VARCHAR NOT NULL, "name" VARCHAR NOT NULL, "system" VARCHAR, code VARCHAR, members_json JSON, definition VARCHAR, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK((kind IN ('metric', 'group'))));;
CREATE TABLE profiles(profile_id VARCHAR PRIMARY KEY, profile_type VARCHAR NOT NULL, scope_kind VARCHAR NOT NULL, track_id VARCHAR, user_id VARCHAR, data_json JSON NOT NULL, source_last_at TIMESTAMP, source_hash VARCHAR, format_version VARCHAR DEFAULT('v1') NOT NULL, computed_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK((scope_kind IN ('student_track', 'user', 'track'))));;
CREATE TABLE scores(score_id VARCHAR PRIMARY KEY, track_id VARCHAR NOT NULL, step_id VARCHAR, student_id VARCHAR NOT NULL, metric_id VARCHAR NOT NULL, raw_value INTEGER NOT NULL, corrected_value INTEGER, "value" INTEGER, rater_user_id VARCHAR NOT NULL, role_at_rate VARCHAR NOT NULL, "comment" VARCHAR, measured_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, attached_at TIMESTAMP, corrected_by_user_id VARCHAR, corrected_at TIMESTAMP, computed_at TIMESTAMP, value_version VARCHAR, value_source VARCHAR, CHECK((raw_value BETWEEN 0 AND 100)), CHECK(((corrected_value IS NULL) OR (corrected_value BETWEEN 0 AND 100))), CHECK((("value" IS NULL) OR ("value" BETWEEN 0 AND 100))), CHECK((role_at_rate IN ('student', 'teacher', 'mentor'))));;
CREATE TABLE sessions(session_id VARCHAR PRIMARY KEY, user_id VARCHAR NOT NULL, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, expires_at TIMESTAMP NOT NULL, revoked_at TIMESTAMP, ip_hash VARCHAR, user_agent VARCHAR, session_type VARCHAR);;
CREATE TABLE sys_events(sys_event_id VARCHAR PRIMARY KEY, event_type VARCHAR NOT NULL, actor_user_id VARCHAR, subject_user_id VARCHAR, context VARCHAR, occurred_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL);;
CREATE TABLE sys_event_types(event_type VARCHAR PRIMARY KEY, description VARCHAR);;
CREATE TABLE tracks(track_id VARCHAR PRIMARY KEY, title VARCHAR NOT NULL, description VARCHAR, owner_user_id VARCHAR NOT NULL, next_track_id VARCHAR, status VARCHAR DEFAULT('draft') NOT NULL, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK((status IN ('draft', 'active', 'archived'))));;
CREATE TABLE track_participants(track_id VARCHAR, user_id VARCHAR, role_in_track VARCHAR NOT NULL, joined_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK((role_in_track IN ('owner', 'teacher', 'student', 'mentor', 'assistant'))), PRIMARY KEY(track_id, user_id));;
CREATE TABLE track_steps(step_id VARCHAR PRIMARY KEY, track_id VARCHAR NOT NULL, step_type VARCHAR NOT NULL, actor_user_id VARCHAR, payload JSON, occurred_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, step_title VARCHAR);;
CREATE TABLE track_step_types(step_type VARCHAR PRIMARY KEY, description VARCHAR, step_title_template VARCHAR);;
CREATE TABLE users(user_id VARCHAR PRIMARY KEY, display_name VARCHAR NOT NULL, email VARCHAR, banned BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, frozen BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, mentor_user_id VARCHAR, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, telegram_id BIGINT, telegram_username VARCHAR, telegram_login_name VARCHAR, telegram_photo_url VARCHAR, web_login VARCHAR, password_hash VARCHAR, is_system BOOLEAN, undeletable BOOLEAN, last_connected TIMESTAMP);;
CREATE TABLE user_roles(user_id VARCHAR, "role" VARCHAR, granted_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK(("role" IN ('owner', 'admin', 'teacher', 'student', 'mentor'))), PRIMARY KEY(user_id, "role"));;
CREATE VIEW v_real_people_roles AS WITH roles_union AS ((SELECT user_id, "role" AS "role", NULL AS track_id FROM user_roles) UNION ALL (SELECT user_id, role_in_track AS "role", track_id FROM track_participants))SELECT u.user_id, u.display_name, u.telegram_id, u.telegram_username, string_agg(DISTINCT r."role", ', ' ORDER BY r."role") AS roles_all, u.last_connected, CASE  WHEN ((u.last_connected IS NULL)) THEN ('âŒ Ð½Ð¸ÐºÐ¾Ð³Ð´Ð°') WHEN ((u.last_connected >= (now() - CAST('1 day' AS INTERVAL)))) THEN ('ðŸŸ¢ ÑÐµÐ³Ð¾Ð´Ð½Ñ') WHEN ((u.last_connected >= (now() - CAST('7 day' AS INTERVAL)))) THEN ('ðŸŸ¡ Ð½Ð° Ð½ÐµÐ´ÐµÐ»Ðµ') ELSE 'âš« Ð´Ð°Ð²Ð½Ð¾' END AS activity_status FROM users AS u LEFT JOIN roles_union AS r USING (user_id) WHERE (u.telegram_id IS NOT NULL) GROUP BY u.user_id, u.display_name, u.telegram_id, u.telegram_username, u.last_connected ORDER BY u.last_connected DESC NULLS LAST;;
CREATE VIEW v_students AS WITH student_tracks AS (SELECT DISTINCT tp.track_id, tp.user_id, tp.joined_at FROM track_participants AS tp WHERE (tp.role_in_track = 'student')), student_users AS (SELECT DISTINCT user_id FROM student_tracks), score_last AS (SELECT student_id, max(measured_at) AS last_score_at FROM scores GROUP BY student_id)SELECT u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, count(DISTINCT st.track_id) AS tracks_total, count(DISTINCT CASE  WHEN ((t.status = 'active')) THEN (st.track_id) ELSE NULL END) AS tracks_active, count(DISTINCT te.user_id) AS teachers_total, count(DISTINCT me.user_id) AS mentors_total, max(st.joined_at) AS last_joined_at, max(ts.occurred_at) AS last_step_in_tracks_at, sl.last_score_at FROM student_users AS su INNER JOIN users AS u ON ((u.user_id = su.user_id)) LEFT JOIN student_tracks AS st ON ((st.user_id = u.user_id)) LEFT JOIN tracks AS t ON ((t.track_id = st.track_id)) LEFT JOIN track_participants AS te ON (((te.track_id = st.track_id) AND (te.role_in_track = 'teacher'))) LEFT JOIN track_participants AS me ON (((me.track_id = st.track_id) AND (me.role_in_track = 'mentor'))) LEFT JOIN track_steps AS ts ON ((ts.track_id = st.track_id)) LEFT JOIN score_last AS sl ON ((sl.student_id = u.user_id)) GROUP BY u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, sl.last_score_at;;
CREATE VIEW v_teachers AS WITH teacher_tracks AS (SELECT DISTINCT tp.track_id, tp.user_id, tp.joined_at FROM track_participants AS tp WHERE (tp.role_in_track = 'teacher')), teacher_users AS (SELECT DISTINCT user_id FROM teacher_tracks), last_activity AS (SELECT actor_user_id AS user_id, max(occurred_at) AS last_step_at FROM track_steps GROUP BY actor_user_id)SELECT u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, count(DISTINCT tt.track_id) AS tracks_total, count(DISTINCT CASE  WHEN ((t.status = 'active')) THEN (tt.track_id) ELSE NULL END) AS tracks_active, count(DISTINCT st.user_id) AS students_total, max(tt.joined_at) AS last_joined_at, max(ts.occurred_at) AS last_step_in_tracks_at, la.last_step_at AS last_activity_at FROM teacher_users AS tu INNER JOIN users AS u ON ((u.user_id = tu.user_id)) LEFT JOIN teacher_tracks AS tt ON ((tt.user_id = u.user_id)) LEFT JOIN tracks AS t ON ((t.track_id = tt.track_id)) LEFT JOIN track_participants AS st ON (((st.track_id = tt.track_id) AND (st.role_in_track = 'student'))) LEFT JOIN track_steps AS ts ON ((ts.track_id = tt.track_id)) LEFT JOIN last_activity AS la ON ((la.user_id = u.user_id)) GROUP BY u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, la.last_step_at;;
CREATE VIEW v_tracks_admin_overview AS WITH p AS (SELECT track_id, count(DISTINCT user_id) AS participants_total, sum(CASE  WHEN ((role_in_track = 'student')) THEN (1) ELSE 0 END) AS students_total, sum(CASE  WHEN ((role_in_track = 'owner')) THEN (1) ELSE 0 END) AS owners_in_participants, sum(CASE  WHEN ((role_in_track NOT IN ('owner', 'student'))) THEN (1) ELSE 0 END) AS bad_roles_cnt, string_agg(DISTINCT role_in_track, ', ') AS roles_list FROM track_participants GROUP BY track_id), s AS (SELECT track_id, count_star() AS steps_total, min(occurred_at) AS first_step_at, max(occurred_at) AS last_step_at, sum(CASE  WHEN ((occurred_at >= (now() - CAST('7 day' AS INTERVAL)))) THEN (1) ELSE 0 END) AS steps_last7 FROM track_steps GROUP BY track_id), m AS (SELECT track_id, count_star() AS measurements_total, max(measured_at) AS last_score_at FROM scores GROUP BY track_id), nxt AS (SELECT t1.track_id, t2.title AS next_track_title FROM tracks AS t1 LEFT JOIN tracks AS t2 ON ((t2.track_id = t1.next_track_id)))SELECT t.track_id, t.title, t.status, t.next_track_id, nxt.next_track_title, t.owner_user_id, ou.display_name AS owner_name, ou.telegram_username AS owner_telegram, COALESCE(p.participants_total, 0) AS participants_total, COALESCE(p.students_total, 0) AS students_total, COALESCE(p.roles_list, '') AS roles_list, COALESCE(s.steps_total, 0) AS steps_total, s.first_step_at, s.last_step_at, COALESCE(s.steps_last7, 0) AS steps_last7, COALESCE(m.measurements_total, 0) AS measurements_total, m.last_score_at, ((COALESCE(p.owners_in_participants, 0) = 1) AND (t.owner_user_id IS NOT NULL)) AS owner_in_participants, (COALESCE(p.bad_roles_cnt, 0) = 0) AS roles_clean FROM tracks AS t LEFT JOIN p ON ((p.track_id = t.track_id)) LEFT JOIN s ON ((s.track_id = t.track_id)) LEFT JOIN m ON ((m.track_id = t.track_id)) LEFT JOIN nxt ON ((nxt.track_id = t.track_id)) LEFT JOIN users AS ou ON ((ou.user_id = t.owner_user_id)) ORDER BY lower(t.title);;
