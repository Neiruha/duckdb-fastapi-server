CREATE TABLE banned_users(ban_id VARCHAR PRIMARY KEY, user_id VARCHAR, telegram_user_id BIGINT, reason VARCHAR, banned_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL);;
CREATE TABLE client_tokens(token_id VARCHAR PRIMARY KEY, user_id VARCHAR NOT NULL, telegram_user_id BIGINT NOT NULL, token_hash VARCHAR NOT NULL, "role" VARCHAR DEFAULT('client') NOT NULL, issued_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, expires_at TIMESTAMP NOT NULL, revoked_at TIMESTAMP, user_agent VARCHAR, ip_hash VARCHAR, last_used_at TIMESTAMP);;
CREATE TABLE creatures(creature_id VARCHAR PRIMARY KEY, owner_user_id VARCHAR NOT NULL, "name" VARCHAR NOT NULL, persona VARCHAR, avatar_url VARCHAR, is_system BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL);;
CREATE TABLE messages(message_id VARCHAR, message_type VARCHAR, origin VARCHAR, sender_user_id VARCHAR, sender_creature_id VARCHAR, telegram_username VARCHAR, telegram_user_id BIGINT, related_sys_event_id VARCHAR, related_track_step_id VARCHAR, "content" VARCHAR, message_data_json JSON, log_data VARCHAR, created_at TIMESTAMP);;
CREATE TABLE message_recipients(message_id VARCHAR, recipient_user_id VARCHAR, read_flag BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, read_at TIMESTAMP, PRIMARY KEY(message_id, recipient_user_id));;
CREATE TABLE message_types(message_type VARCHAR PRIMARY KEY, description VARCHAR);;
CREATE TABLE metrics(metric_id VARCHAR PRIMARY KEY, "name" VARCHAR NOT NULL, metric_type VARCHAR NOT NULL, definition VARCHAR, anchors_json JSON, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK((metric_type IN ('adult', 'child', 'triage', 'disc'))));;
CREATE TABLE metric_groups(group_id VARCHAR PRIMARY KEY, "name" VARCHAR NOT NULL, description VARCHAR, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, element_code VARCHAR, element_ru VARCHAR);;
CREATE TABLE metric_group_members(group_id VARCHAR, metric_id VARCHAR, weight DOUBLE NOT NULL, PRIMARY KEY(group_id, metric_id), CHECK(((weight >= 0) AND (weight <= 1))));;
CREATE TABLE metric_types(metric_type VARCHAR PRIMARY KEY, description VARCHAR);;
CREATE TABLE sessions(session_id VARCHAR PRIMARY KEY, user_id VARCHAR NOT NULL, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, expires_at TIMESTAMP NOT NULL, revoked_at TIMESTAMP, ip_hash VARCHAR, user_agent VARCHAR, session_type VARCHAR);;
CREATE TABLE step_metric_scores(score_id VARCHAR PRIMARY KEY, step_id VARCHAR NOT NULL, student_id VARCHAR NOT NULL, metric_id VARCHAR NOT NULL, "value" INTEGER NOT NULL, rater_user_id VARCHAR NOT NULL, role_at_rate VARCHAR, "comment" VARCHAR, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK(("value" BETWEEN 0 AND 100)));;
CREATE TABLE sys_events(sys_event_id VARCHAR PRIMARY KEY, event_type VARCHAR NOT NULL, actor_user_id VARCHAR, subject_user_id VARCHAR, context VARCHAR, occurred_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL);;
CREATE TABLE sys_event_types(event_type VARCHAR PRIMARY KEY, description VARCHAR);;
CREATE TABLE tracks(track_id VARCHAR PRIMARY KEY, title VARCHAR NOT NULL, description VARCHAR, owner_user_id VARCHAR NOT NULL, start_at TIMESTAMP, end_at TIMESTAMP, next_track_id VARCHAR, status VARCHAR DEFAULT('draft') NOT NULL, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK((status IN ('draft', 'active', 'archived'))));;
CREATE TABLE track_participants(track_id VARCHAR, user_id VARCHAR, role_in_track VARCHAR NOT NULL, joined_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK((role_in_track IN ('owner', 'teacher', 'student', 'mentor', 'assistant'))), PRIMARY KEY(track_id, user_id));;
CREATE TABLE track_steps(step_id VARCHAR PRIMARY KEY, track_id VARCHAR NOT NULL, step_type VARCHAR NOT NULL, actor_user_id VARCHAR, payload JSON, occurred_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, step_title VARCHAR);;
CREATE TABLE track_step_types(step_type VARCHAR PRIMARY KEY, description VARCHAR, step_title_template VARCHAR);;
CREATE TABLE users(user_id VARCHAR PRIMARY KEY, display_name VARCHAR NOT NULL, email VARCHAR, banned BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, frozen BOOLEAN DEFAULT(CAST('f' AS BOOLEAN)) NOT NULL, mentor_user_id VARCHAR, created_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, updated_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, telegram_id BIGINT, telegram_username VARCHAR, telegram_login_name VARCHAR, telegram_photo_url VARCHAR, web_login VARCHAR, password_hash VARCHAR, is_system BOOLEAN, undeletable BOOLEAN, last_connected TIMESTAMP);;
CREATE TABLE user_roles(user_id VARCHAR, "role" VARCHAR, granted_at TIMESTAMP DEFAULT(CURRENT_TIMESTAMP) NOT NULL, CHECK(("role" IN ('owner', 'admin', 'teacher', 'student', 'mentor'))), PRIMARY KEY(user_id, "role"));;
CREATE VIEW v_mentors AS WITH mentor_tracks AS (SELECT DISTINCT tp.track_id, tp.user_id, tp.joined_at FROM track_participants AS tp WHERE (tp.role_in_track = 'mentor')), mentor_users AS ((SELECT DISTINCT u.user_id FROM users AS u INNER JOIN user_roles AS ur ON (((ur.user_id = u.user_id) AND (ur."role" = 'mentor')))) UNION (SELECT DISTINCT tp.user_id FROM track_participants AS tp WHERE (tp.role_in_track = 'mentor')))SELECT u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, count(DISTINCT mt.track_id) AS tracks_total, count(DISTINCT CASE  WHEN ((t.status = 'active')) THEN (mt.track_id) ELSE NULL END) AS tracks_active, count(DISTINCT st.user_id) AS students_total, count(DISTINCT te.user_id) AS teachers_total, max(mt.joined_at) AS last_joined_at, max(ts.occurred_at) AS last_step_in_tracks_at FROM mentor_users AS mu INNER JOIN users AS u ON ((u.user_id = mu.user_id)) LEFT JOIN mentor_tracks AS mt ON ((mt.user_id = u.user_id)) LEFT JOIN tracks AS t ON ((t.track_id = mt.track_id)) LEFT JOIN track_participants AS st ON (((st.track_id = mt.track_id) AND (st.role_in_track = 'student'))) LEFT JOIN track_participants AS te ON (((te.track_id = mt.track_id) AND (te.role_in_track = 'teacher'))) LEFT JOIN track_steps AS ts ON ((ts.track_id = mt.track_id)) GROUP BY u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected;;
CREATE VIEW v_real_people_roles AS WITH roles_union AS ((SELECT user_id, "role" AS "role", NULL AS track_id FROM user_roles) UNION ALL (SELECT user_id, role_in_track AS "role", track_id FROM track_participants))SELECT u.user_id, u.display_name, u.telegram_id, u.telegram_username, string_agg(DISTINCT r."role", ', ' ORDER BY r."role") AS roles_all, u.last_connected, CASE  WHEN ((u.last_connected IS NULL)) THEN ('âŒ Ð½Ð¸ÐºÐ¾Ð³Ð´Ð°') WHEN ((u.last_connected >= (now() - CAST('1 day' AS INTERVAL)))) THEN ('ðŸŸ¢ ÑÐµÐ³Ð¾Ð´Ð½Ñ') WHEN ((u.last_connected >= (now() - CAST('7 day' AS INTERVAL)))) THEN ('ðŸŸ¡ Ð½Ð° Ð½ÐµÐ´ÐµÐ»Ðµ') ELSE 'âš« Ð´Ð°Ð²Ð½Ð¾' END AS activity_status FROM users AS u LEFT JOIN roles_union AS r USING (user_id) WHERE (u.telegram_id IS NOT NULL) GROUP BY u.user_id, u.display_name, u.telegram_id, u.telegram_username, u.last_connected ORDER BY u.last_connected DESC NULLS LAST;;
CREATE VIEW v_students AS WITH student_tracks AS (SELECT DISTINCT tp.track_id, tp.user_id, tp.joined_at FROM track_participants AS tp WHERE (tp.role_in_track = 'student')), student_users AS ((SELECT DISTINCT u.user_id FROM users AS u INNER JOIN user_roles AS ur ON (((ur.user_id = u.user_id) AND (ur."role" = 'student')))) UNION (SELECT DISTINCT tp.user_id FROM track_participants AS tp WHERE (tp.role_in_track = 'student'))), score_last AS (SELECT student_id, max(created_at) AS last_score_at FROM step_metric_scores GROUP BY 1)SELECT u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, count(DISTINCT st.track_id) AS tracks_total, count(DISTINCT CASE  WHEN ((t.status = 'active')) THEN (st.track_id) ELSE NULL END) AS tracks_active, count(DISTINCT te.user_id) AS teachers_total, count(DISTINCT me.user_id) AS mentors_total, max(st.joined_at) AS last_joined_at, max(ts.occurred_at) AS last_step_in_tracks_at, sl.last_score_at AS last_score_at FROM student_users AS su INNER JOIN users AS u ON ((u.user_id = su.user_id)) LEFT JOIN student_tracks AS st ON ((st.user_id = u.user_id)) LEFT JOIN tracks AS t ON ((t.track_id = st.track_id)) LEFT JOIN track_participants AS te ON (((te.track_id = st.track_id) AND (te.role_in_track = 'teacher'))) LEFT JOIN track_participants AS me ON (((me.track_id = st.track_id) AND (me.role_in_track = 'mentor'))) LEFT JOIN track_steps AS ts ON ((ts.track_id = st.track_id)) LEFT JOIN score_last AS sl ON ((sl.student_id = u.user_id)) GROUP BY u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, sl.last_score_at;;
CREATE VIEW v_teachers AS WITH teacher_tracks AS (SELECT DISTINCT tp.track_id, tp.user_id, tp.joined_at FROM track_participants AS tp WHERE (tp.role_in_track = 'teacher')), teacher_users AS ((SELECT DISTINCT u.user_id FROM users AS u INNER JOIN user_roles AS ur ON (((ur.user_id = u.user_id) AND (ur."role" = 'teacher')))) UNION (SELECT DISTINCT tp.user_id FROM track_participants AS tp WHERE (tp.role_in_track = 'teacher'))), last_score AS (SELECT s.actor_user_id AS user_id, max(s.occurred_at) AS last_step_at FROM track_steps AS s GROUP BY 1)SELECT u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, count(DISTINCT tt.track_id) AS tracks_total, count(DISTINCT CASE  WHEN ((t.status = 'active')) THEN (tt.track_id) ELSE NULL END) AS tracks_active, count(DISTINCT st.user_id) AS students_total, max(tt.joined_at) AS last_joined_at, max(ts.occurred_at) AS last_step_in_tracks_at, COALESCE(ls.last_step_at, NULL) AS last_step_by_user_at FROM teacher_users AS tu INNER JOIN users AS u ON ((u.user_id = tu.user_id)) LEFT JOIN teacher_tracks AS tt ON ((tt.user_id = u.user_id)) LEFT JOIN tracks AS t ON ((t.track_id = tt.track_id)) LEFT JOIN track_participants AS st ON (((st.track_id = tt.track_id) AND (st.role_in_track = 'student'))) LEFT JOIN track_steps AS ts ON ((ts.track_id = tt.track_id)) LEFT JOIN last_score AS ls ON ((ls.user_id = u.user_id)) GROUP BY u.user_id, u.display_name, u.email, u.telegram_username, u.telegram_id, u.banned, u.frozen, u.created_at, u.last_connected, ls.last_step_at;;
CREATE VIEW v_tracks_admin_overview AS WITH p AS (SELECT tp.track_id, count(DISTINCT tp.user_id) AS participants_total, sum(CASE  WHEN ((tp.role_in_track = 'student')) THEN (1) ELSE 0 END) AS students_total, sum(CASE  WHEN ((tp.role_in_track = 'owner')) THEN (1) ELSE 0 END) AS owners_in_participants, sum(CASE  WHEN ((tp.role_in_track NOT IN ('owner', 'student'))) THEN (1) ELSE 0 END) AS bad_roles_cnt, string_agg(DISTINCT tp.role_in_track, ', ') AS roles_list FROM track_participants AS tp GROUP BY 1), s AS (SELECT ts.track_id, count_star() AS steps_total, min(ts.occurred_at) AS first_step_at, max(ts.occurred_at) AS last_step_at, sum(CASE  WHEN ((ts.occurred_at >= (CURRENT_TIMESTAMP - CAST('7 day' AS INTERVAL)))) THEN (1) ELSE 0 END) AS steps_last7 FROM track_steps AS ts GROUP BY 1), m AS (SELECT s.track_id, count_star() AS measurements_total, max(sms.created_at) AS last_score_at FROM step_metric_scores AS sms INNER JOIN track_steps AS s ON ((s.step_id = sms.step_id)) GROUP BY 1), nxt AS (SELECT t1.track_id, t2.title AS next_track_title FROM tracks AS t1 LEFT JOIN tracks AS t2 ON ((t2.track_id = t1.next_track_id)))SELECT t.track_id, t.title, t.status, t.start_at, t.end_at, t.next_track_id, nxt.next_track_title, t.owner_user_id, ou.display_name AS owner_name, ou.telegram_username AS owner_telegram, COALESCE(p.participants_total, 0) AS participants_total, COALESCE(p.students_total, 0) AS students_total, COALESCE(p.roles_list, '') AS roles_list, COALESCE(s.steps_total, 0) AS steps_total, s.first_step_at, s.last_step_at, COALESCE(s.steps_last7, 0) AS steps_last7, COALESCE(m.measurements_total, 0) AS measurements_total, m.last_score_at, CASE  WHEN (((COALESCE(p.owners_in_participants, 0) = 1) AND (t.owner_user_id IS NOT NULL))) THEN (CAST('t' AS BOOLEAN)) ELSE CAST('f' AS BOOLEAN) END AS owner_in_participants, CASE  WHEN ((COALESCE(p.bad_roles_cnt, 0) = 0)) THEN (CAST('t' AS BOOLEAN)) ELSE CAST('f' AS BOOLEAN) END AS roles_clean, CASE  WHEN ((s.last_step_at IS NULL)) THEN (CAST('t' AS BOOLEAN)) ELSE (s.last_step_at <= COALESCE(t.end_at, CAST('9999-12-31' AS TIMESTAMP))) END AS steps_within_track_window FROM tracks AS t LEFT JOIN p ON ((p.track_id = t.track_id)) LEFT JOIN s ON ((s.track_id = t.track_id)) LEFT JOIN m ON ((m.track_id = t.track_id)) LEFT JOIN nxt ON ((nxt.track_id = t.track_id)) LEFT JOIN users AS ou ON ((ou.user_id = t.owner_user_id)) ORDER BY lower(t.title);;
CREATE VIEW v_tracks_participants_detail AS WITH base AS (SELECT tp.track_id, tp.user_id, tp.role_in_track, u.display_name, u.telegram_username FROM track_participants AS tp INNER JOIN users AS u ON ((u.user_id = tp.user_id))), roles_pvt AS (SELECT b.track_id, count_star() AS participants_total, sum(CASE  WHEN ((b.role_in_track = 'owner')) THEN (1) ELSE 0 END) AS owners_cnt, sum(CASE  WHEN ((b.role_in_track = 'student')) THEN (1) ELSE 0 END) AS students_cnt FROM base AS b GROUP BY 1), samples AS (SELECT b.track_id, string_agg(b.display_name, ', ' ORDER BY b.display_name) FILTER (WHERE (b.role_in_track = 'owner')) AS owners_names, string_agg(b.display_name, ', ' ORDER BY b.display_name) FILTER (WHERE (b.role_in_track = 'student')) AS students_all_names FROM base AS b GROUP BY 1), students_sample AS (SELECT q.track_id, string_agg(q.display_name, ', ' ORDER BY q.display_name) AS students_sample_10 FROM (SELECT b.track_id, b.display_name, row_number() OVER (PARTITION BY b.track_id ORDER BY b.display_name) AS rn FROM base AS b WHERE (b.role_in_track = 'student')) AS q WHERE (q.rn <= 10) GROUP BY q.track_id)SELECT t.track_id, t.title, t.status, t.owner_user_id, ou.display_name AS owner_name, ou.telegram_username AS owner_telegram, rp.participants_total, rp.students_cnt AS students_total, s.owners_names, COALESCE(ss.students_sample_10, '') AS students_sample_10, CASE  WHEN (((s.students_all_names IS NOT NULL) AND (length(s.students_all_names) > length(COALESCE(ss.students_sample_10, ''))))) THEN (CAST('t' AS BOOLEAN)) ELSE CAST('f' AS BOOLEAN) END AS students_more_hidden FROM tracks AS t LEFT JOIN users AS ou ON ((ou.user_id = t.owner_user_id)) LEFT JOIN roles_pvt AS rp ON ((rp.track_id = t.track_id)) LEFT JOIN samples AS s ON ((s.track_id = t.track_id)) LEFT JOIN students_sample AS ss ON ((ss.track_id = t.track_id));;
CREATE INDEX ix_client_tokens_exp ON client_tokens(expires_at);;
CREATE INDEX ix_client_tokens_tg ON client_tokens(telegram_user_id);;
CREATE INDEX ix_client_tokens_user ON client_tokens(user_id);;
CREATE INDEX ix_creatures_owner ON creatures(owner_user_id);;
CREATE INDEX ix_creatures_system ON creatures(is_system);;
CREATE INDEX ix_messages_created ON messages(created_at);;
CREATE INDEX ix_messages_related_sys_event ON messages(related_sys_event_id);;
CREATE INDEX ix_messages_sender_creature ON messages(sender_creature_id);;
CREATE INDEX ix_messages_sender_user ON messages(sender_user_id);;
CREATE INDEX ix_messages_tg_user ON messages(telegram_user_id);;
CREATE INDEX ix_messages_type ON messages(message_type);;
CREATE INDEX ix_mgm_group ON metric_group_members(group_id);;
CREATE INDEX ix_mgm_metric ON metric_group_members(metric_id);;
CREATE INDEX ix_msgrec_recipient ON message_recipients(recipient_user_id);;
CREATE INDEX ix_sessions_expiry ON sessions(expires_at);;
CREATE INDEX ix_sessions_user ON sessions(user_id);;
CREATE INDEX ix_sms_metric ON step_metric_scores(metric_id);;
CREATE INDEX ix_sms_rater ON step_metric_scores(rater_user_id);;
CREATE INDEX ix_sms_step ON step_metric_scores(step_id);;
CREATE INDEX ix_sms_student ON step_metric_scores(student_id);;
CREATE INDEX ix_steps_time ON track_steps(occurred_at);;
CREATE INDEX ix_steps_track ON track_steps(track_id);;
CREATE INDEX ix_steps_type ON track_steps(step_type);;
CREATE INDEX ix_sysevents_actor ON sys_events(actor_user_id);;
CREATE INDEX ix_sysevents_subject ON sys_events(subject_user_id);;
CREATE INDEX ix_sysevents_type ON sys_events(event_type);;
CREATE INDEX ix_sysevents_when ON sys_events(occurred_at);;
CREATE INDEX ix_tp_role ON track_participants(role_in_track);;
CREATE INDEX ix_tracks_next ON tracks(next_track_id);;
CREATE INDEX ix_tracks_owner ON tracks(owner_user_id);;
CREATE INDEX ix_users_mentor ON users(mentor_user_id);;
CREATE INDEX ix_users_telegram_name ON users(telegram_login_name);;
CREATE UNIQUE INDEX ux_banned_tg ON banned_users(telegram_user_id);;
CREATE UNIQUE INDEX ux_banned_user ON banned_users(user_id);;
CREATE UNIQUE INDEX ux_client_tokens_hash ON client_tokens(token_hash);;
CREATE UNIQUE INDEX ux_users_telegram_id ON users(telegram_id);;
CREATE UNIQUE INDEX ux_users_web_login ON users(web_login);;
